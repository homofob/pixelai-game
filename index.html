<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelAi - P Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDMgHvo7BVKkWBqLA0ixMHB2Zn1qZr2cu0", 
            authDomain: "pixelaigame.firebaseapp.com", 
            projectId: "pixelaigame", 
            storageBucket: "pixelaigame.firebasestorage.app", 
            messagingSenderId: "612539280987", 
            appId: "1:612539280987:web:568b7f14a7e95caa1c197e" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Робимо функції глобальними, щоб звичайний <script> міг їх бачити
        window.firebaseDB = { db, doc, getDoc, setDoc, updateDoc };
        console.log("Firebase initialized!");
    </script>

    <style>
        :root { --accent-green: #2ecc71; --bg-dark: #050505; }
        body { 
            margin: 0; 
            background: linear-gradient(rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9)), 
                        url('https://api.dicebear.com/7.x/pixel-art/svg?seed=P&backgroundColor=050505&tileLightness=0.2'); 
            background-size: 100px 100px;
            color: #fff; font-family: 'Press Start 2P', cursive; text-align: center; min-height: 100vh;
            overflow-x: hidden;
        }
        .header-container { width: 100%; height: 100px; position: relative; border-bottom: 3px solid var(--accent-green); background: #000; display: flex; align-items: center; overflow: hidden; }
        #pixelCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .header-content { width: 100%; display: grid; grid-template-columns: 180px 1fr 180px; align-items: center; padding: 0 20px; z-index: 5; }
        #walletBtn { font-family: 'Press Start 2P'; font-size: 8px; padding: 8px 12px; border: 2px solid var(--accent-green); background: #000; color: var(--accent-green); cursor: pointer; white-space: nowrap; }
        .logo-pixel { font-size: 26px; font-weight: bold; background: linear-gradient(90deg, #66ff00, #1eff00, #00ff00, #00ff59d1, #00ff95f4); background-size: 400%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: rainbow 10s linear infinite; }
        @keyframes rainbow { 0% { background-position: 0%; } 100% { background-position: 400%; } }
        .top-right-balance { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); border: 2px solid var(--accent-green); padding: 10px; font-size: 10px; z-index: 100; }
        nav { display: flex; gap: 10px; justify-content: center; margin: 25px 0; z-index: 10; position: relative; flex-wrap: wrap; }
        nav button { background: #1a1a1a; border: 2px solid #444; color: #fff; padding: 12px 18px; font-family: 'Press Start 2P'; font-size: 10px; cursor: pointer; }
        nav button.active-nav { border-color: var(--accent-green); color: var(--accent-green); background: rgba(46, 204, 113, 0.1); }
        .coin-container { position: relative; width: 180px; height: 180px; margin: 40px auto; }
        .main-coin { width: 100%; height: 100%; background: radial-gradient(circle, #2ecc71 0%, #1b5e20 100%); border: 6px solid #fff; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 80px; color: white; text-shadow: 4px 4px 0px #1b5e20; animation: pulse-glow-green 2s infinite alternate; user-select: none; }
        @keyframes pulse-glow-green { from { box-shadow: 0 0 20px rgba(46,204,113,0.4); transform: scale(1); } to { box-shadow: 0 0 50px rgba(46,204,113,0.8); transform: scale(1.05); } }
        .floating-text { position: absolute; color: var(--accent-green); font-size: 20px; pointer-events: none; animation: floatUp 0.8s ease-out forwards; z-index: 100; text-shadow: 2px 2px #000; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } }
        .wheel-wrapper { position: relative; width: 210px; margin: 20px auto; }
        .wheel-pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); color: white; font-size: 30px; z-index: 20; }
        #wheel-container { width: 200px; height: 200px; border: 5px solid #fff; border-radius: 50%; overflow: hidden; transition: transform 3s cubic-bezier(0.1, 0, 0.1, 1); position: relative; }
        .card { background: rgba(17, 17, 17, 0.9); border: 3px solid var(--accent-green); padding: 25px; margin-top: 15px; border-radius: 10px; }
        .container { display: none; padding: 20px; }
        .active { display: block; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 500px; margin: 0 auto; }
        .shop-item { border: 2px solid #333; background: rgba(22, 22, 22, 0.9); padding: 25px; min-height: 120px; }
        .buy-btn { width: 100%; background: var(--accent-green); color: #000; border: none; padding: 10px; font-family: 'Press Start 2P'; font-size: 9px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: #333; height: 15px; border: 2px solid var(--accent-green); margin: 20px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 35px; width: 35px; background: var(--accent-green); cursor: pointer; border: 3px solid #fff; }
        .period-btn { background: #1a1a1a; border: 3px solid #444; color: #fff; padding: 20px 5px; font-family: 'Press Start 2P'; font-size: 11px; cursor: pointer; width: 32%; }
        .period-btn.selected-green { border-color: var(--accent-green); color: var(--accent-green); background: rgba(46, 204, 113, 0.2); }
    </style>
</head>
<body>

    <div class="top-right-balance">PAI: <span id="balanceSide">0</span></div>

    <div class="header-container">
        <canvas id="pixelCanvas"></canvas> 
        <div class="header-content">
            <button id="walletBtn" onclick="connectWallet()">CONNECT WALLET</button>
            <div class="logo-pixel">PixelAi</div>
            <div></div> 
        </div>
    </div>

    <nav>
        <button onclick="showSection('tapper', this)" class="active-nav">FARMING</button>
        <button onclick="showSection('staking', this)">STAKING</button>
        <button onclick="showSection('shop', this)">BOOSTS</button>
        <button onclick="showSection('listing', this)">LISTING</button>
        <button onclick="showSection('referral', this)">FRIENDS</button>
        <button onclick="showSection('daily', this)">SPIN</button>
    </nav>

    <div id="tapper" class="container active">
        <p>WALLET: <span id="balance">0</span> PAI</p>
        <div class="coin-container">
            <div class="main-coin" onclick="handleTap(event)">P</div>
        </div>
        <p>ENERGY: <span id="energy">10</span>/10</p>
    </div>

    <div id="staking" class="container">... (твій код стейкінгу) ...</div>

    <script>
        // --- ПЕРЕМІННІ ---
        let balance = parseInt(localStorage.getItem('pai_balance')) || 0;
        let energy = parseInt(localStorage.getItem('pai_energy')) || 10;
        let userWallet = localStorage.getItem('pai_wallet') || null;

        // --- FIREBASE ФУНКЦІЇ ---
        async function loadUserData(wallet) {
            if (!window.firebaseDB) return; // Чекаємо завантаження Firebase
            const { db, doc, getDoc, setDoc } = window.firebaseDB;
            const docRef = doc(db, "users", wallet.toLowerCase());
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                balance = data.balance || 0;
                energy = data.energy || 10;
            } else {
                await setDoc(docRef, { balance: balance, energy: energy, lastSeen: Date.now() });
            }
            updateUI();
        }

        async function saveUserData() {
            if (!userWallet || !window.firebaseDB) return;
            const { db, doc, updateDoc } = window.firebaseDB;
            const docRef = doc(db, "users", userWallet.toLowerCase());
            await updateDoc(docRef, { balance: balance, energy: energy, lastSeen: Date.now() });
        }

        // --- ТАПАЛКА ---
        function handleTap(e) {
            if(!userWallet) { alert("Connect Wallet First!"); return; }
            if(energy > 0) {
                balance++; energy--;
                showPlusOne(e);
                updateUI();
            }
        }

        function showPlusOne(e) {
            const text = document.createElement('div');
            text.className = 'floating-text';
            text.innerText = '+1';
            text.style.left = e.clientX + 'px'; //clientX краще для позиціонування
            text.style.top = e.clientY + 'px';
            document.body.appendChild(text);
            setTimeout(() => text.remove(), 800);
        }

        function updateUI() {
            document.getElementById('balance').innerText = balance;
            document.getElementById('balanceSide').innerText = balance;
            document.getElementById('energy').innerText = energy;
            localStorage.setItem('pai_balance', balance);
            localStorage.setItem('pai_energy', energy);
        }

        // --- ГАМАНЕЦЬ ---
        async function connectWallet() {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userWallet = accounts[0];
                    localStorage.setItem('pai_wallet', userWallet);
                    document.getElementById('walletBtn').innerText = userWallet.slice(0,6).toUpperCase() + "...";
                    await loadUserData(userWallet);
                } catch (err) {
                    console.error("Wallet connection failed", err);
                }
            } else {
                alert("Please install MetaMask!");
            }
        }

        // --- ПІКСЕЛЬНИЙ ДОЩ ТА ІНШЕ ---
        // (Тут залишаєш свої функції анімації та перемикання розділів)
        function showSection(id, btn) {
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-nav'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active-nav');
        }

        // Автозбереження кожні 30 сек
        setInterval(saveUserData, 30000);

        // Ініціалізація при завантаженні
        window.onload = () => {
            if(userWallet) {
                document.getElementById('walletBtn').innerText = userWallet.slice(0,6).toUpperCase() + "...";
                // Невеликий тайм-аут, щоб Firebase встиг прокинутись
                setTimeout(() => loadUserData(userWallet), 1000);
            }
            updateUI();
        };

        // Твій код анімації канвасу...
        const canvas = document.getElementById('pixelCanvas');
        const ctx = canvas.getContext('2d');
        let pixels = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = 100; }
        window.addEventListener('resize', resize);
        resize();
        class Pixel {
            constructor() { this.reset(); }
            reset() { this.x = Math.random() * canvas.width; this.y = -10; this.size = Math.random() * 3 + 1; this.speed = Math.random() * 2 + 1; this.color = 'rgba(46, 204, 113, ' + Math.random() + ')'; }
            update() { this.y += this.speed; if(this.y > 100) this.reset(); }
            draw() { ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, this.size, this.size); }
        }
        for(let i=0; i<120; i++) pixels.push(new Pixel());
        function animate() { ctx.clearRect(0,0,canvas.width, 100); pixels.forEach(p => {p.update(); p.draw();}); requestAnimationFrame(animate); }
        animate();
    </script>
</body>
</html>
